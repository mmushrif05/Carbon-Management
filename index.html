<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CarbonTrack Pro | Construction Sustainability Platform</title>
<style>
:root {
  --bg: #0b0f0e; --bg2: #111916; --bg3: #16201b; --bg4: #1c2a23;
  --border: rgba(52,211,153,0.12); --border2: rgba(52,211,153,0.06);
  --green: #34d399; --green2: #059669; --green3: #047857;
  --blue: #60a5fa; --orange: #fb923c; --red: #f87171; --purple: #a78bfa; --cyan: #22d3ee; --yellow: #fbbf24;
  --slate3: #cbd5e1; --slate4: #94a3b8; --slate5: #64748b; --slate6: #475569;
  --text: #ecfdf5; --text2: #a7f3d0; --text3: #6ee7b7;
  --sidebar-w: 240px; --radius: 12px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* DB STATUS */
.db-status{position:fixed;top:12px;right:12px;z-index:999;display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:20px;font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase}
.db-status.online{background:rgba(52,211,153,0.1);border:1px solid rgba(52,211,153,0.3);color:var(--green)}
.db-status.offline{background:rgba(248,113,113,0.1);border:1px solid rgba(248,113,113,0.3);color:var(--red)}
.db-status .db-dot{width:7px;height:7px;border-radius:50%;animation:pulse 2s infinite}
.db-status.online .db-dot{background:var(--green)}
.db-status.offline .db-dot{background:var(--red)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}

/* LOGIN */
#loginScreen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:radial-gradient(ellipse at 30% 20%,rgba(5,150,105,0.08),transparent 60%),var(--bg)}
.login-card{width:480px;max-width:92vw;text-align:center}
.login-logo{font-size:42px;margin-bottom:8px}
.login-title{font-size:28px;font-weight:800;letter-spacing:-1px;margin-bottom:4px}
.login-title span{color:var(--green)}
.login-sub{font-size:13px;color:var(--slate4);margin-bottom:28px}
.login-label{font-size:10px;font-weight:700;letter-spacing:1.5px;color:var(--text3);text-transform:uppercase;margin-bottom:10px;text-align:left}
.role-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:20px}
.role-btn{padding:20px 12px;background:var(--bg2);border:2px solid var(--border);border-radius:14px;cursor:pointer;transition:all .25s;text-align:center}
.role-btn:hover{border-color:var(--green);background:var(--bg3)}
.role-btn.selected{border-color:var(--green);background:rgba(52,211,153,0.08)}
.role-btn .r-icon{font-size:28px;margin-bottom:8px}
.role-btn .r-name{font-size:13px;font-weight:700;color:var(--text);margin-bottom:4px}
.role-btn .r-desc{font-size:10px;color:var(--slate5);line-height:1.4}
.login-input{margin-bottom:16px;text-align:left}
.login-input input{width:100%;padding:12px 16px;background:var(--bg2);border:2px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;outline:none;transition:border-color .2s}
.login-input input:focus{border-color:var(--green)}
.login-input input::placeholder{color:var(--slate6)}
.login-project{margin-bottom:20px;text-align:left}
.login-project select{width:100%;padding:12px 16px;background:var(--bg2);border:2px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;outline:none;appearance:none;cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%2334d399' stroke-width='2'%3E%3Cpath d='M2 4l4 4 4-4'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center}
.login-project select option{background:var(--bg2)}
.login-footer{font-size:10px;color:var(--slate6);margin-top:24px}
.login-error{display:none;padding:10px;background:rgba(248,113,113,0.1);border:1px solid rgba(248,113,113,0.2);border-radius:8px;color:var(--red);font-size:12px;margin-bottom:12px;text-align:left}
.login-toggle{font-size:12px;color:var(--slate4);margin-top:16px}
.login-toggle a{color:var(--green);cursor:pointer;text-decoration:underline}
.login-toggle a:hover{color:var(--text3)}
.login-btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--green3),var(--green2));border:none;border-radius:10px;color:#fff;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s;font-family:inherit;letter-spacing:.3px}
.login-btn:hover{box-shadow:0 4px 20px rgba(5,150,105,0.35)}
.login-btn:disabled{opacity:0.5;cursor:not-allowed}
.login-btn-secondary{width:100%;padding:14px;background:var(--bg3);border:2px solid var(--border);border-radius:10px;color:var(--text2);font-size:14px;font-weight:700;cursor:pointer;transition:all .2s;font-family:inherit;margin-top:10px}
.login-btn-secondary:hover{border-color:var(--green)}

/* APP SHELL */
#appShell{display:none}
.app-layout{display:flex;min-height:100vh}
.sidebar{width:var(--sidebar-w);background:var(--bg2);border-right:1px solid var(--border2);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100;transition:transform .3s}
.sb-header{padding:20px 16px 16px;border-bottom:1px solid var(--border2)}
.sb-logo{display:flex;align-items:center;gap:8px;margin-bottom:4px}
.sb-logo-icon{font-size:22px}
.sb-logo-text{font-size:16px;font-weight:800;letter-spacing:-.5px}
.sb-logo-text span{color:var(--green)}
.sb-version{font-size:9px;color:var(--slate5);letter-spacing:1px;text-transform:uppercase}
.sb-nav{flex:1;padding:12px 8px;overflow-y:auto}
.sb-section{font-size:9px;font-weight:700;letter-spacing:1.5px;color:var(--slate5);text-transform:uppercase;padding:12px 12px 6px}
.sb-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;transition:all .2s;font-size:13px;font-weight:500;color:var(--slate4);margin-bottom:2px}
.sb-item:hover{background:var(--bg3);color:var(--text2)}
.sb-item.active{background:rgba(52,211,153,0.1);color:var(--green);font-weight:600}
.sb-item .sb-icon{width:20px;text-align:center;font-size:15px}
.sb-item .sb-badge{margin-left:auto;padding:2px 7px;background:rgba(251,146,60,0.15);border-radius:10px;font-size:10px;font-weight:700;color:var(--orange)}
.sb-footer{padding:12px 16px;border-top:1px solid var(--border2)}
.sb-user{display:flex;align-items:center;gap:10px}
.sb-avatar{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700}
.sb-avatar.contractor{background:rgba(96,165,250,0.15);color:var(--blue)}
.sb-avatar.consultant{background:rgba(52,211,153,0.15);color:var(--green)}
.sb-avatar.client{background:rgba(167,139,250,0.15);color:var(--purple)}
.sb-uname{font-size:12px;font-weight:600}
.sb-urole{font-size:10px;color:var(--slate5);text-transform:capitalize}
.sb-logout{margin-top:8px;font-size:11px;color:var(--slate5);cursor:pointer;text-decoration:underline}
.sb-logout:hover{color:var(--red)}

.main-content{margin-left:var(--sidebar-w);flex:1;min-height:100vh}
.page-header{padding:24px 32px 20px;border-bottom:1px solid var(--border2);background:linear-gradient(180deg,var(--bg2),var(--bg))}
.page-title{font-size:22px;font-weight:700}
.page-desc{font-size:12px;color:var(--slate4);margin-top:4px}
.page-body{padding:24px 32px}
.page{display:none}.page.active{display:block}

.card{background:var(--bg2);border:1px solid var(--border2);border-radius:var(--radius);padding:20px;margin-bottom:16px}
.card-title{font-size:11px;font-weight:700;letter-spacing:1.5px;color:var(--text3);text-transform:uppercase;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.card-title::after{content:'';flex:1;height:1px;background:var(--border2)}

.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:24px}
.stat-card{padding:18px 16px;border-radius:var(--radius);border:1px solid transparent;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.stat-card .sc-label{font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;opacity:.7;margin-bottom:6px}
.stat-card .sc-value{font-size:clamp(20px,3vw,28px);font-weight:800;line-height:1.1}
.stat-card .sc-sub{font-size:10px;opacity:.5;margin-top:4px}
.stat-card.green{background:rgba(52,211,153,0.06);border-color:rgba(52,211,153,0.12);color:var(--green)}.stat-card.green::before{background:var(--green)}
.stat-card.blue{background:rgba(96,165,250,0.06);border-color:rgba(96,165,250,0.12);color:var(--blue)}.stat-card.blue::before{background:var(--blue)}
.stat-card.orange{background:rgba(251,146,60,0.06);border-color:rgba(251,146,60,0.12);color:var(--orange)}.stat-card.orange::before{background:var(--orange)}
.stat-card.purple{background:rgba(167,139,250,0.06);border-color:rgba(167,139,250,0.12);color:var(--purple)}.stat-card.purple::before{background:var(--purple)}
.stat-card.slate{background:rgba(148,163,184,0.06);border-color:rgba(148,163,184,0.1);color:var(--slate3)}.stat-card.slate::before{background:var(--slate4)}
.stat-card.cyan{background:rgba(34,211,238,0.06);border-color:rgba(34,211,238,0.12);color:var(--cyan)}.stat-card.cyan::before{background:var(--cyan)}

.form-row{display:grid;gap:12px;margin-bottom:14px}
.form-row.c2{grid-template-columns:1fr 1fr}.form-row.c3{grid-template-columns:1fr 1fr 1fr}.form-row.c4{grid-template-columns:1fr 1fr 1fr 1fr}
@media(max-width:768px){.form-row.c3,.form-row.c4{grid-template-columns:1fr 1fr}}
@media(max-width:480px){.form-row.c2,.form-row.c3,.form-row.c4{grid-template-columns:1fr}}
.fg label{display:block;font-size:10px;font-weight:700;letter-spacing:1px;color:var(--text2);margin-bottom:5px;text-transform:uppercase}
.fg input,.fg select,.fg textarea{width:100%;padding:10px 12px;background:var(--bg3);border:1.5px solid var(--border);border-radius:8px;color:#fff;font-size:14px;outline:none;transition:border-color .2s;font-family:inherit}
.fg input:focus,.fg select:focus{border-color:var(--green)}
.fg input::placeholder{color:var(--slate6);font-size:12px}
.fg select{appearance:none;cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='none' stroke='%2334d399' stroke-width='2'%3E%3Cpath d='M1 3l4 4 4-4'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px}
.fg select option{background:var(--bg2)}
.fg .fg-help{font-size:10px;color:var(--slate5);margin-top:3px}
.fg .fg-readonly{background:var(--bg4);border-color:transparent;color:var(--green);font-weight:700;pointer-events:none}
.btn{padding:11px 20px;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;font-family:inherit;letter-spacing:.3px}
.btn:active{transform:scale(.97)}
.btn-primary{background:linear-gradient(135deg,var(--green3),var(--green2));color:#fff;box-shadow:0 4px 16px rgba(5,150,105,0.25)}
.btn-secondary{background:var(--bg3);color:var(--text2);border:1.5px solid var(--border)}
.btn-danger{background:rgba(248,113,113,0.1);color:var(--red);border:1.5px solid rgba(248,113,113,0.2)}
.btn-approve{background:rgba(52,211,153,0.1);color:var(--green);border:1.5px solid rgba(52,211,153,0.2)}
.btn-row{display:flex;gap:10px;margin-top:16px}
.btn-sm{padding:7px 14px;font-size:11px;border-radius:8px}
.tbl-wrap{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:12px}
th{padding:10px 8px;font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--green);border-bottom:1.5px solid var(--border);white-space:nowrap;text-align:left}
th.r{text-align:right}
td{padding:10px 8px;border-bottom:1px solid var(--border2)}
td.r{text-align:right;font-variant-numeric:tabular-nums}
td.mono{font-family:'Courier New',monospace;font-size:11px}
.badge{display:inline-flex;padding:3px 10px;border-radius:6px;font-size:10px;font-weight:700;letter-spacing:.5px}
.badge.pending{background:rgba(251,191,36,0.1);color:var(--yellow);border:1px solid rgba(251,191,36,0.2)}
.badge.review{background:rgba(96,165,250,0.1);color:var(--blue);border:1px solid rgba(96,165,250,0.2)}
.badge.approved{background:rgba(52,211,153,0.1);color:var(--green);border:1px solid rgba(52,211,153,0.2)}
.badge.rejected{background:rgba(248,113,113,0.1);color:var(--red);border:1px solid rgba(248,113,113,0.2)}
.bar-chart{display:flex;align-items:flex-end;gap:12px;height:200px;padding:0 8px;border-bottom:1px solid var(--border2)}
.bar-group{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;height:100%;justify-content:flex-end}
.bar-pair{display:flex;gap:3px;align-items:flex-end;width:100%;justify-content:center}
.bar{width:20px;border-radius:4px 4px 0 0;transition:height .5s ease;min-height:2px}
.bar.baseline{background:rgba(148,163,184,0.35)}.bar.actual{background:rgba(96,165,250,0.5)}
.bar-label{font-size:9px;color:var(--slate5);text-align:center;margin-top:6px}
.chart-legend{display:flex;gap:16px;justify-content:center;margin-top:12px;font-size:10px;color:var(--slate4)}
.chart-legend-dot{display:inline-block;width:10px;height:10px;border-radius:3px;margin-right:5px;vertical-align:middle}
.donut-wrap{display:flex;align-items:center;gap:24px}
.donut-svg{width:140px;height:140px}
.donut-legend{display:flex;flex-direction:column;gap:8px}
.donut-legend-item{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--slate3)}
.donut-legend-dot{width:12px;height:12px;border-radius:3px;flex-shrink:0}
.cert-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
.cert-card{padding:16px;border-radius:var(--radius);border:1.5px solid var(--border);background:var(--bg3);text-align:center;transition:all .2s}
.cert-card:hover{border-color:var(--green)}
.cert-card .cc-icon{font-size:28px;margin-bottom:8px}
.cert-card .cc-name{font-size:14px;font-weight:700;margin-bottom:4px}
.cert-card .cc-status{font-size:10px;color:var(--slate5)}
.cert-card .cc-bar{height:6px;background:var(--bg);border-radius:3px;margin-top:10px;overflow:hidden}
.cert-card .cc-fill{height:100%;border-radius:3px;transition:width .5s}
.api-item{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--bg3);border:1px solid var(--border2);border-radius:10px;margin-bottom:8px}
.api-left{display:flex;align-items:center;gap:12px}
.api-icon{font-size:20px}
.api-name{font-size:13px;font-weight:600}
.api-desc{font-size:10px;color:var(--slate5)}
.toggle{width:44px;height:24px;border-radius:12px;background:var(--bg);border:2px solid var(--border);cursor:pointer;position:relative;transition:all .2s}
.toggle.on{background:rgba(52,211,153,0.2);border-color:var(--green)}
.toggle::after{content:'';position:absolute;width:16px;height:16px;border-radius:50%;background:var(--slate5);top:2px;left:2px;transition:all .2s}
.toggle.on::after{background:var(--green);left:22px}
.flow-steps{display:flex;align-items:center;gap:0;margin:16px 0}
.flow-step{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1}
.flow-dot{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;border:2px solid var(--border);background:var(--bg3)}
.flow-dot.done{border-color:var(--green);background:rgba(52,211,153,0.1)}
.flow-dot.current{border-color:var(--blue);background:rgba(96,165,250,0.1);animation:pulseFlow 2s infinite}
@keyframes pulseFlow{0%,100%{box-shadow:0 0 0 0 rgba(96,165,250,0.3)}50%{box-shadow:0 0 0 8px rgba(96,165,250,0)}}
.flow-label{font-size:9px;font-weight:600;color:var(--slate5);text-transform:uppercase;letter-spacing:.5px}
.flow-line{flex:1;height:2px;background:var(--border);margin:0 -4px;margin-bottom:18px}
.flow-line.done{background:var(--green)}
.empty{text-align:center;padding:40px;color:var(--slate5)}
.empty-icon{font-size:36px;opacity:.3;margin-bottom:8px}
.total-row td{font-weight:700;border-top:2px solid rgba(34,197,94,0.2);border-bottom:none;padding-top:12px}
.menu-toggle{display:none;position:fixed;top:16px;left:16px;z-index:200;width:40px;height:40px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;cursor:pointer;font-size:18px;color:var(--green);align-items:center;justify-content:center}
@media(max-width:768px){.sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0)}.main-content{margin-left:0}.menu-toggle{display:flex}.page-body{padding:16px}.page-header{padding:16px 16px 14px 60px}}

/* LOADING OVERLAY */
.loading-overlay{position:fixed;inset:0;background:rgba(11,15,14,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999}
.loading-spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--green);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{margin-top:16px;color:var(--green);font-size:13px;font-weight:600}
</style>
</head>
<body>

<!-- DB STATUS INDICATOR -->
<div class="db-status offline" id="dbStatus">
  <span class="db-dot"></span>
  <span id="dbStatusText">Connecting...</span>
</div>

<!-- LOADING -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text">Connecting to database...</div>
</div>

<!-- LOGIN -->
<div id="loginScreen" style="display:none">
  <div class="login-card">
    <div class="login-logo">üåç</div>
    <div class="login-title">Carbon<span>Track</span> Pro</div>
    <div class="login-sub">Construction Embodied Carbon & Sustainability Platform</div>

    <!-- SIGN IN FORM -->
    <div id="loginForm">
      <div class="login-input">
        <div class="login-label">Email</div>
        <input id="loginEmail" type="email" placeholder="Enter your email" autocomplete="email" />
      </div>

      <div class="login-input">
        <div class="login-label">Password</div>
        <input id="loginPassword" type="password" placeholder="Enter your password" autocomplete="current-password" />
      </div>

      <div class="login-error" id="loginError"></div>

      <button class="login-btn" id="loginBtn" onclick="handleLogin()">Sign In</button>

      <div class="login-toggle">Don't have an account? <a onclick="showRegister()">Create one</a></div>
    </div>

    <!-- REGISTER FORM -->
    <div id="registerForm" style="display:none">
      <div class="login-input">
        <div class="login-label">Full Name</div>
        <input id="regName" placeholder="Enter your full name" autocomplete="name" />
      </div>

      <div class="login-input">
        <div class="login-label">Email</div>
        <input id="regEmail" type="email" placeholder="Enter your email" autocomplete="email" />
      </div>

      <div class="login-input">
        <div class="login-label">Password</div>
        <input id="regPassword" type="password" placeholder="Minimum 6 characters" autocomplete="new-password" />
      </div>

      <div class="login-project">
        <div class="login-label">Project</div>
        <select id="regProject">
          <option value="ksia">King Salman International Airport (KSIA)</option>
        </select>
      </div>

      <div class="login-label">Select Your Role</div>
      <div class="role-grid" id="regRoleGrid">
        <div class="role-btn" onclick="selectRole('contractor',this)"><div class="r-icon">üèóÔ∏è</div><div class="r-name">Contractor</div><div class="r-desc">Enter actual material data & EPDs</div></div>
        <div class="role-btn" onclick="selectRole('consultant',this)"><div class="r-icon">üìã</div><div class="r-name">Consultant</div><div class="r-desc">Review, approve & set baselines</div></div>
        <div class="role-btn" onclick="selectRole('client',this)"><div class="r-icon">üëî</div><div class="r-name">Client</div><div class="r-desc">Dashboard, approvals & reports</div></div>
      </div>

      <div class="login-error" id="regError"></div>

      <button class="login-btn" id="regBtn" onclick="handleRegister()">Create Account</button>

      <div class="login-toggle">Already have an account? <a onclick="showLogin()">Sign in</a></div>
    </div>

    <div class="login-footer">v2.0 ‚Ä¢ Cloud Database Enabled ‚Ä¢ KSIA Sustainability Program</div>
  </div>
</div>

<!-- APP -->
<div id="appShell" style="display:none">
  <button class="menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞</button>
  <div class="app-layout">
    <nav class="sidebar" id="sidebar">
      <div class="sb-header"><div class="sb-logo"><span class="sb-logo-icon">üåç</span><span class="sb-logo-text">Carbon<span>Track</span></span></div><div class="sb-version">Pro v2.0 ‚Ä¢ Cloud DB</div></div>
      <div class="sb-nav" id="sidebarNav"></div>
      <div class="sb-footer"><div class="sb-user"><div class="sb-avatar" id="userAvatar">C</div><div><div class="sb-uname" id="userName">User</div><div class="sb-urole" id="userRole">Role</div></div></div><div class="sb-logout" onclick="logout()">‚Üê Sign Out</div></div>
    </nav>
    <div class="main-content">
      <div class="page-header"><div class="page-title" id="pageTitle">Dashboard</div><div class="page-desc" id="pageDesc"></div></div>
      <div class="page-body" id="pageBody"></div>
    </div>
  </div>
</div>

<!-- ===== FIREBASE SDK (v9 compat) ===== -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë  üîß FIREBASE CONFIG ‚Äî REPLACE WITH YOUR OWN                ‚ïë
// ‚ïë  Follow the setup guide to get these values                 ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "000000000000",
  appId: "YOUR_APP_ID"
};

// ===== INIT FIREBASE =====
let db = null;
let dbConnected = false;

try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();

  // Monitor connection
  db.ref('.info/connected').on('value', snap => {
    dbConnected = snap.val() === true;
    updateDbStatus();
  });
} catch(e) {
  console.warn('Firebase init failed, using localStorage fallback:', e);
}

function updateDbStatus() {
  const el = document.getElementById('dbStatus');
  const txt = document.getElementById('dbStatusText');
  if (dbConnected) { el.className='db-status online'; txt.textContent='Database Connected'; }
  else { el.className='db-status offline'; txt.textContent='Offline (Local)'; }
}

// ===== DATABASE ABSTRACTION LAYER =====
// Works with Firebase when connected, falls back to localStorage
const DB = {
  async getEntries() {
    if (dbConnected) {
      const snap = await db.ref('projects/ksia/entries').once('value');
      const data = snap.val();
      return data ? Object.values(data) : [];
    }
    return JSON.parse(localStorage.getItem('ct_entries') || '[]');
  },

  async saveEntry(entry) {
    if (dbConnected) {
      await db.ref('projects/ksia/entries/' + entry.id).set(entry);
    }
    // Always save locally too as backup
    const entries = JSON.parse(localStorage.getItem('ct_entries') || '[]');
    entries.push(entry);
    localStorage.setItem('ct_entries', JSON.stringify(entries));
  },

  async updateEntry(id, updates) {
    if (dbConnected) {
      await db.ref('projects/ksia/entries/' + id).update(updates);
    }
    const entries = JSON.parse(localStorage.getItem('ct_entries') || '[]');
    const idx = entries.findIndex(e => e.id === id);
    if (idx !== -1) { Object.assign(entries[idx], updates); localStorage.setItem('ct_entries', JSON.stringify(entries)); }
  },

  async deleteEntry(id) {
    if (dbConnected) {
      await db.ref('projects/ksia/entries/' + id).remove();
    }
    let entries = JSON.parse(localStorage.getItem('ct_entries') || '[]');
    entries = entries.filter(e => e.id !== id);
    localStorage.setItem('ct_entries', JSON.stringify(entries));
  },

  async getA5Entries() {
    if (dbConnected) {
      const snap = await db.ref('projects/ksia/a5entries').once('value');
      const data = snap.val();
      return data ? Object.values(data) : [];
    }
    return JSON.parse(localStorage.getItem('ct_a5entries') || '[]');
  },

  async saveA5Entry(entry) {
    if (dbConnected) {
      await db.ref('projects/ksia/a5entries/' + entry.id).set(entry);
    }
    const entries = JSON.parse(localStorage.getItem('ct_a5entries') || '[]');
    entries.push(entry);
    localStorage.setItem('ct_a5entries', JSON.stringify(entries));
  },

  async deleteA5Entry(id) {
    if (dbConnected) {
      await db.ref('projects/ksia/a5entries/' + id).remove();
    }
    let entries = JSON.parse(localStorage.getItem('ct_a5entries') || '[]');
    entries = entries.filter(e => e.id !== id);
    localStorage.setItem('ct_a5entries', JSON.stringify(entries));
  },

  // Real-time listener for live updates across users
  onEntriesChange(callback) {
    if (dbConnected) {
      db.ref('projects/ksia/entries').on('value', snap => {
        const data = snap.val();
        callback(data ? Object.values(data) : []);
      });
    }
  },

  onA5Change(callback) {
    if (dbConnected) {
      db.ref('projects/ksia/a5entries').on('value', snap => {
        const data = snap.val();
        callback(data ? Object.values(data) : []);
      });
    }
  }
};

// ===== MATERIAL & EF DATA =====
const MATERIALS = {
  Concrete:{unit:"m¬≥",massFactor:2400,efUnit:"kgCO‚ÇÇe/m¬≥",types:[
    {name:"C15-20",baseline:323,target:220},{name:"C20-30",baseline:354,target:301},{name:"C30-40",baseline:431,target:340},
    {name:"C40-50",baseline:430,target:360},{name:"C50-60",baseline:483,target:342},{name:"C60-70",baseline:522,target:345}]},
  Steel:{unit:"kg",massFactor:1,efUnit:"kgCO‚ÇÇe/kg",types:[
    {name:"Structural (I sections)",baseline:2.46,target:1.78},{name:"Rebar",baseline:2.26,target:1.30},
    {name:"Hollow (Tube) sections",baseline:2.52,target:1.83},{name:"Hot Dip Galvanized",baseline:2.74,target:2.07}]},
  Asphalt:{unit:"tons",massFactor:1000,efUnit:"kgCO‚ÇÇe/ton",types:[
    {name:"3% Binder",baseline:50.1,target:40.08},{name:"3.5% Binder",baseline:51.1,target:40.88},{name:"4% Binder",baseline:52.2,target:41.76},
    {name:"4.5% Binder",baseline:53.2,target:42.56},{name:"5% Binder",baseline:54.2,target:43.36},{name:"5.5% Binder",baseline:55.3,target:44.24},
    {name:"6% Binder",baseline:56.3,target:45.04},{name:"6.5% Binder",baseline:57.3,target:45.84},{name:"7% Binder",baseline:58.4,target:46.72}]},
  Aluminum:{unit:"kg",massFactor:1,efUnit:"kgCO‚ÇÇe/kg",types:[
    {name:"Profile Without Coating",baseline:8.24,target:6.59},{name:"Profile With Coating",baseline:9.12,target:7.30},
    {name:"Sheets Without Coating",baseline:7.85,target:6.28},{name:"Anodized Sections",baseline:10.20,target:8.16}]},
  Glass:{unit:"kg",massFactor:1,efUnit:"kgCO‚ÇÇe/kg",types:[
    {name:"Annealed",baseline:1.30,target:1.04},{name:"Coated",baseline:1.60,target:1.28},
    {name:"Laminated",baseline:1.80,target:1.44},{name:"IGU",baseline:2.50,target:2.00}]},
  Pipes:{unit:"m",massFactor:1,efUnit:"kgCO‚ÇÇe/m",types:[
    {name:"Precast 600mm",baseline:138.89,target:138.89},{name:"Precast 800mm",baseline:241.29,target:241.29},
    {name:"Precast 1000mm",baseline:394.70,target:394.70},{name:"Precast 1200mm",baseline:543.80,target:543.80}]},
  Earthwork:{unit:"tons",massFactor:1000,efUnit:"kgCO‚ÇÇe/ton",types:[
    {name:"Excavation/Hauling",baseline:3.50,target:2.80},{name:"Coarse Aggregate",baseline:5.20,target:4.16},{name:"Sand",baseline:4.80,target:3.84}]},
};
const A5_EFS = {
  energy:[{name:"Diesel",ef:2.51,unit:"L",efUnit:"kgCO‚ÇÇe/L"},{name:"Gasoline",ef:2.31,unit:"L",efUnit:"kgCO‚ÇÇe/L"},{name:"Grid Electricity",ef:0.611,unit:"kWh",efUnit:"kgCO‚ÇÇe/kWh"},{name:"Renewable",ef:0,unit:"kWh",efUnit:"kgCO‚ÇÇe/kWh"}],
  water:[{name:"Potable Water",ef:14.7,unit:"m¬≥",efUnit:"kgCO‚ÇÇ/m¬≥"},{name:"Construction Water",ef:4.0,unit:"m¬≥",efUnit:"kgCO‚ÇÇ/m¬≥"},{name:"TSE Recycled",ef:1.2,unit:"m¬≥",efUnit:"kgCO‚ÇÇ/m¬≥"}]
};
const TEF={road:0.0000121,sea:0.0000026,train:0.0000052};
const MONTHS=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
const CERTS=[{name:"Envision",icon:"üèóÔ∏è",color:"var(--green)",cr:14,tgt:10},{name:"Mostadam",icon:"üè†",color:"var(--cyan)",cr:8,tgt:6},{name:"LEED",icon:"üåø",color:"var(--green)",cr:12,tgt:8},{name:"BREEAM",icon:"üåç",color:"var(--blue)",cr:10,tgt:7},{name:"WELL",icon:"üíö",color:"var(--purple)",cr:6,tgt:4}];

// ===== STATE =====
let state = { role:null, name:'', page:'dashboard', entries:[], a5entries:[] };
const fmt=v=>(v==null||isNaN(v))?"‚Äî":v.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
const fmtI=v=>(v==null||isNaN(v))?"‚Äî":Math.round(v).toLocaleString();
const $=id=>document.getElementById(id);

// ===== LOAD DATA =====
async function loadAllData() {
  state.entries = await DB.getEntries();
  state.a5entries = await DB.getA5Entries();

  // Setup real-time listeners
  DB.onEntriesChange(data => { state.entries = data; if (state.page) navigate(state.page); });
  DB.onA5Change(data => { state.a5entries = data; if (state.page === 'entry_a5' || state.page === 'dashboard') navigate(state.page); });
}

// ===== FIREBASE AUTH =====
let auth = null;
let selectedRegRole = null;

try {
  auth = firebase.auth();
} catch(e) {
  console.warn('Firebase Auth init failed:', e);
}

// Show/hide login vs register forms
function showRegister() {
  $('loginForm').style.display = 'none';
  $('registerForm').style.display = 'block';
  clearErrors();
}
function showLogin() {
  $('registerForm').style.display = 'none';
  $('loginForm').style.display = 'block';
  clearErrors();
}
function clearErrors() {
  $('loginError').style.display = 'none';
  $('regError').style.display = 'none';
}

// Role selection during registration
function selectRole(role, el) {
  selectedRegRole = role;
  document.querySelectorAll('#regRoleGrid .role-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
}

// Show an error on a given error element
function showError(elId, msg) {
  const el = $(elId);
  el.style.display = 'block';
  el.textContent = msg;
}

// Map Firebase auth error codes to user-friendly messages
function authErrorMessage(code) {
  const map = {
    'auth/email-already-in-use': 'An account with this email already exists.',
    'auth/invalid-email': 'Please enter a valid email address.',
    'auth/weak-password': 'Password must be at least 6 characters.',
    'auth/user-not-found': 'No account found with this email.',
    'auth/wrong-password': 'Incorrect password.',
    'auth/invalid-credential': 'Invalid email or password.',
    'auth/too-many-requests': 'Too many attempts. Please try again later.',
    'auth/network-request-failed': 'Network error. Please check your connection.'
  };
  return map[code] || 'Authentication failed. Please try again.';
}

// Save user profile to Firebase DB
async function saveUserProfile(uid, name, email, role) {
  if (dbConnected) {
    await db.ref('users/' + uid).set({
      name: name,
      email: email,
      role: role,
      createdAt: new Date().toISOString()
    });
  }
  // Also keep in localStorage as fallback
  localStorage.setItem('ct_user_profile', JSON.stringify({ uid, name, email, role }));
}

// Load user profile from Firebase DB
async function loadUserProfile(uid) {
  if (dbConnected) {
    const snap = await db.ref('users/' + uid).once('value');
    const profile = snap.val();
    if (profile) {
      localStorage.setItem('ct_user_profile', JSON.stringify({ uid, ...profile }));
      return profile;
    }
  }
  // Fallback to localStorage
  const cached = JSON.parse(localStorage.getItem('ct_user_profile') || 'null');
  if (cached && cached.uid === uid) return cached;
  return null;
}

// ===== OFFLINE AUTH (localStorage fallback when Firebase is not configured) =====
function offlineGetUsers() {
  return JSON.parse(localStorage.getItem('ct_auth_users') || '{}');
}
function offlineSaveUsers(users) {
  localStorage.setItem('ct_auth_users', JSON.stringify(users));
}
function simpleHash(str) {
  let h = 0;
  for (let i = 0; i < str.length; i++) { h = ((h << 5) - h + str.charCodeAt(i)) | 0; }
  return 'h_' + Math.abs(h).toString(36);
}

// Handle login form submission
async function handleLogin() {
  clearErrors();
  const email = $('loginEmail').value.trim();
  const password = $('loginPassword').value;

  if (!email) { showError('loginError', 'Please enter your email.'); return; }
  if (!password) { showError('loginError', 'Please enter your password.'); return; }

  $('loginBtn').disabled = true;
  $('loginBtn').textContent = 'Signing in...';

  // Firebase auth
  if (auth) {
    try {
      await auth.signInWithEmailAndPassword(email, password);
      // onAuthStateChanged will handle the rest
      return;
    } catch(e) {
      showError('loginError', authErrorMessage(e.code));
      $('loginBtn').disabled = false;
      $('loginBtn').textContent = 'Sign In';
      return;
    }
  }

  // Offline auth fallback
  const users = offlineGetUsers();
  const user = users[email];
  if (!user) {
    showError('loginError', 'No account found with this email. Please register first.');
    $('loginBtn').disabled = false;
    $('loginBtn').textContent = 'Sign In';
    return;
  }
  if (user.passHash !== simpleHash(password)) {
    showError('loginError', 'Incorrect password.');
    $('loginBtn').disabled = false;
    $('loginBtn').textContent = 'Sign In';
    return;
  }
  // Success ‚Äî save session and enter app
  localStorage.setItem('ct_auth_session', JSON.stringify({ email: email, uid: user.uid }));
  enterApp(user.name, user.role);
}

// Handle registration form submission
async function handleRegister() {
  clearErrors();
  const name = $('regName').value.trim();
  const email = $('regEmail').value.trim();
  const password = $('regPassword').value;

  if (!name) { showError('regError', 'Please enter your name.'); return; }
  if (!email) { showError('regError', 'Please enter your email.'); return; }
  if (!password) { showError('regError', 'Please enter a password.'); return; }
  if (password.length < 6) { showError('regError', 'Password must be at least 6 characters.'); return; }
  if (!selectedRegRole) { showError('regError', 'Please select a role.'); return; }

  $('regBtn').disabled = true;
  $('regBtn').textContent = 'Creating account...';

  // Firebase auth
  if (auth) {
    try {
      const cred = await auth.createUserWithEmailAndPassword(email, password);
      await cred.user.updateProfile({ displayName: name });
      await saveUserProfile(cred.user.uid, name, email, selectedRegRole);
      // onAuthStateChanged will handle the rest
      return;
    } catch(e) {
      showError('regError', authErrorMessage(e.code));
      $('regBtn').disabled = false;
      $('regBtn').textContent = 'Create Account';
      return;
    }
  }

  // Offline auth fallback
  const users = offlineGetUsers();
  if (users[email]) {
    showError('regError', 'An account with this email already exists.');
    $('regBtn').disabled = false;
    $('regBtn').textContent = 'Create Account';
    return;
  }
  const uid = 'offline_' + Date.now();
  users[email] = { uid, name, email, role: selectedRegRole, passHash: simpleHash(password), createdAt: new Date().toISOString() };
  offlineSaveUsers(users);
  localStorage.setItem('ct_user_profile', JSON.stringify({ uid, name, email, role: selectedRegRole }));
  localStorage.setItem('ct_auth_session', JSON.stringify({ email, uid }));
  enterApp(name, selectedRegRole);
}

// Enter the app after authentication
function enterApp(name, role) {
  state.role = role;
  state.name = name;
  $('loginScreen').style.display = 'none';
  $('appShell').style.display = 'block';
  $('userName').textContent = name;
  $('userRole').textContent = role;
  $('userAvatar').className = 'sb-avatar ' + role;
  $('userAvatar').textContent = name[0].toUpperCase();
  buildSidebar();
  navigate('dashboard');
}

// Logout
function logout() {
  if (auth) {
    auth.signOut();
  }
  localStorage.removeItem('ct_auth_session');
  state.role = null;
  state.name = '';
  $('appShell').style.display = 'none';
  $('loginScreen').style.display = 'flex';
  // Reset form fields
  $('loginEmail').value = '';
  $('loginPassword').value = '';
  $('loginBtn').disabled = false;
  $('loginBtn').textContent = 'Sign In';
  showLogin();
  clearErrors();
}

// ===== INIT =====
async function init() {
  // Wait a moment for Firebase to connect
  setTimeout(async () => {
    updateDbStatus();
    await loadAllData();
    $('loadingOverlay').style.display = 'none';

    // Listen for auth state changes
    if (auth) {
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          // User is signed in ‚Äî load their profile to get role
          const profile = await loadUserProfile(user.uid);
          if (profile) {
            enterApp(profile.name || user.displayName || 'User', profile.role || 'contractor');
          } else {
            // Profile missing (edge case) ‚Äî sign out and ask to re-register
            auth.signOut();
            $('loginScreen').style.display = 'flex';
            showError('loginError', 'Account profile not found. Please register again.');
          }
        } else {
          // User is signed out ‚Äî show login
          $('appShell').style.display = 'none';
          $('loginScreen').style.display = 'flex';
        }
      });
    } else {
      // Firebase not configured ‚Äî check for offline session
      const session = JSON.parse(localStorage.getItem('ct_auth_session') || 'null');
      if (session) {
        const users = offlineGetUsers();
        const user = users[session.email];
        if (user) {
          enterApp(user.name, user.role);
          return;
        }
      }
      $('loginScreen').style.display = 'flex';
    }
  }, 1500);
}
init();

// Allow Enter key to submit login/register forms
document.addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    if ($('loginForm').style.display !== 'none' && $('loginScreen').style.display !== 'none') {
      if (document.activeElement === $('loginEmail') || document.activeElement === $('loginPassword')) {
        handleLogin();
      }
    }
    if ($('registerForm').style.display !== 'none') {
      if (document.activeElement === $('regName') || document.activeElement === $('regEmail') || document.activeElement === $('regPassword')) {
        handleRegister();
      }
    }
  }
});

// ===== SIDEBAR =====
function buildSidebar() {
  const r=state.role;
  const pending=state.entries.filter(e=>e.status==='pending').length;
  const review=state.entries.filter(e=>e.status==='review').length;
  let items=[{section:"Main"},{id:'dashboard',icon:'üìä',label:'Dashboard'}];
  if(r==='contractor'||r==='consultant'){items.push({section:"Data Entry"},{id:'entry_a13',icon:'üß±',label:'A1-A3 Materials'},{id:'entry_a5',icon:'‚ö°',label:'A5 Site Emissions'});}
  items.push({section:"Workflow"},{id:'approvals',icon:'‚úÖ',label:'Approvals',badge:r==='consultant'?pending:(r==='client'?review:0)});
  items.push({section:"Reports"},{id:'monthly',icon:'üìÖ',label:'Monthly Report'},{id:'cumulative',icon:'üìà',label:'Cumulative'});
  if(r==='consultant'||r==='client'){items.push({section:"Config"},{id:'baselines',icon:'‚öôÔ∏è',label:'Baseline EFs'});}
  items.push({id:'certifications',icon:'üèÜ',label:'Certifications'},{id:'integrations',icon:'üîå',label:'API Hub'});

  $('sidebarNav').innerHTML = items.map(it => it.section ? `<div class="sb-section">${it.section}</div>` :
    `<div class="sb-item${state.page===it.id?' active':''}" onclick="navigate('${it.id}')"><span class="sb-icon">${it.icon}</span>${it.label}${it.badge>0?`<span class="sb-badge">${it.badge}</span>`:''}</div>`
  ).join('');
}

// ===== NAV =====
function navigate(page) {
  state.page = page; buildSidebar();
  const titles={dashboard:["Dashboard","Project carbon performance & sustainability metrics"],entry_a13:["A1-A3 Material Entry","Enter material quantities and emission factors"],entry_a5:["A5 Site Emissions","Monthly fuel and water consumption"],approvals:["Approval Workflow","Review and approve carbon data"],monthly:["Monthly Report","Monthly emissions breakdown"],cumulative:["Cumulative Report","Running totals and trends"],baselines:["Baseline EFs","Emission factor reference data"],certifications:["Certifications","Track sustainability certification credits"],integrations:["API Hub","External integrations and data sources"]};
  const[t,d]=titles[page]||["",""];
  $('pageTitle').textContent=t; $('pageDesc').textContent=d;
  const R={dashboard:renderDashboard,entry_a13:renderEntry,entry_a5:renderA5,approvals:renderApprovals,monthly:renderMonthly,cumulative:renderCumulative,baselines:renderBaselines,certifications:renderCerts,integrations:renderIntegrations};
  if(R[page]) R[page]($('pageBody'));
  $('sidebar').classList.remove('open');
}

// ===== DASHBOARD =====
function renderDashboard(el) {
  const d=state.entries; let tB=0,tA=0,tA4=0;
  d.forEach(e=>{tB+=e.a13B||0;tA+=e.a13A||0;tA4+=e.a4||0});
  let a5T=0; state.a5entries.forEach(e=>{a5T+=e.emission||0});
  const rP=tB>0?((tB-tA)/tB)*100:0;
  const matB={}; d.forEach(e=>{if(!matB[e.category])matB[e.category]={b:0,a:0};matB[e.category].b+=e.a13B||0;matB[e.category].a+=e.a13A||0});
  const mMap={}; d.forEach(e=>{const k=e.monthKey;if(!mMap[k])mMap[k]={b:0,a:0,l:e.monthLabel};mMap[k].b+=e.a13B||0;mMap[k].a+=e.a13A||0});
  const mArr=Object.entries(mMap).sort((a,b)=>a[0].localeCompare(b[0]));
  const cols={Concrete:'var(--slate4)',Steel:'var(--blue)',Asphalt:'var(--orange)',Aluminum:'var(--purple)',Glass:'var(--cyan)',Pipes:'var(--yellow)',Earthwork:'#a3e635'};

  el.innerHTML=`
  <div class="stats-row">
    <div class="stat-card slate"><div class="sc-label">A1-A3 Baseline</div><div class="sc-value">${fmt(tB)}</div><div class="sc-sub">ton CO‚ÇÇeq</div></div>
    <div class="stat-card blue"><div class="sc-label">A1-A3 Actual</div><div class="sc-value">${fmt(tA)}</div><div class="sc-sub">ton CO‚ÇÇeq</div></div>
    <div class="stat-card orange"><div class="sc-label">A4 Transport</div><div class="sc-value">${fmt(tA4)}</div><div class="sc-sub">ton CO‚ÇÇeq</div></div>
    <div class="stat-card cyan"><div class="sc-label">A5 Site</div><div class="sc-value">${fmt(a5T)}</div><div class="sc-sub">ton CO‚ÇÇeq</div></div>
    <div class="stat-card green"><div class="sc-label">A1-A5 Total</div><div class="sc-value">${fmt(tA+tA4+a5T)}</div><div class="sc-sub">ton CO‚ÇÇeq</div></div>
    <div class="stat-card ${rP>20?'green':rP>=10?'orange':'purple'}"><div class="sc-label">Reduction</div><div class="sc-value">${fmt(rP)}%</div><div class="sc-sub">${fmt(tB-tA)} saved</div></div>
  </div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
    <div class="card"><div class="card-title">Monthly Trend</div>${mArr.length?`<div class="bar-chart" id="dc"></div><div class="chart-legend"><span><span class="chart-legend-dot" style="background:rgba(148,163,184,0.4)"></span> Baseline</span><span><span class="chart-legend-dot" style="background:rgba(96,165,250,0.5)"></span> Actual</span></div>`:'<div class="empty"><div class="empty-icon">üìä</div>Add entries to see trends</div>'}</div>
    <div class="card"><div class="card-title">By Material</div>${Object.keys(matB).length?`<div class="donut-wrap"><svg class="donut-svg" viewBox="0 0 140 140" id="dn"></svg><div class="donut-legend" id="dl"></div></div>`:'<div class="empty"><div class="empty-icon">üß±</div>No data yet</div>'}</div>
  </div>
  <div class="card"><div class="card-title">Approvals</div><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;text-align:center">
    <div><div style="font-size:24px;font-weight:800;color:var(--yellow)">${d.filter(e=>e.status==='pending').length}</div><div style="font-size:10px;color:var(--slate5)">Pending</div></div>
    <div><div style="font-size:24px;font-weight:800;color:var(--blue)">${d.filter(e=>e.status==='review').length}</div><div style="font-size:10px;color:var(--slate5)">Review</div></div>
    <div><div style="font-size:24px;font-weight:800;color:var(--green)">${d.filter(e=>e.status==='approved').length}</div><div style="font-size:10px;color:var(--slate5)">Approved</div></div>
    <div><div style="font-size:24px;font-weight:800;color:var(--red)">${d.filter(e=>e.status==='rejected').length}</div><div style="font-size:10px;color:var(--slate5)">Rejected</div></div>
  </div></div>`;

  if(mArr.length){const mx=Math.max(...mArr.map(([k,v])=>Math.max(v.b,v.a)),1);$('dc').innerHTML=mArr.map(([k,v])=>`<div class="bar-group"><div class="bar-pair"><div class="bar baseline" style="height:${(v.b/mx)*170}px"></div><div class="bar actual" style="height:${(v.a/mx)*170}px"></div></div><div class="bar-label">${v.l}</div></div>`).join('');}
  if(Object.keys(matB).length){const tot=Object.values(matB).reduce((s,v)=>s+v.a,0)||1;let ang=0,sh='',lh='';Object.entries(matB).forEach(([c,v])=>{const p=v.a/tot;const a1=ang;ang+=p*360;const lg=p>.5?1:0;const r=55,cx=70,cy=70;const x1=cx+r*Math.cos((a1-90)*Math.PI/180),y1=cy+r*Math.sin((a1-90)*Math.PI/180);const x2=cx+r*Math.cos((ang-90)*Math.PI/180),y2=cy+r*Math.sin((ang-90)*Math.PI/180);const cl=cols[c]||'var(--slate4)';if(p>.001)sh+=`<path d="M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${lg},1 ${x2},${y2} Z" fill="${cl}" opacity="0.7" stroke="var(--bg2)" stroke-width="1.5"/>`;lh+=`<div class="donut-legend-item"><div class="donut-legend-dot" style="background:${cl}"></div>${c}: ${fmt(v.a)} tCO‚ÇÇ (${(p*100).toFixed(1)}%)</div>`;});$('dn').innerHTML=sh;$('dl').innerHTML=lh;}
}

// ===== ENTRY =====
function renderEntry(el) {
  const yr=new Date().getFullYear(),mo=String(new Date().getMonth()+1).padStart(2,'0');
  el.innerHTML=`<div class="card"><div class="card-title">New Material Entry ‚Äî A1-A4</div>
  <div class="form-row c4"><div class="fg"><label>Year</label><select id="eY">${[yr-1,yr,yr+1].map(y=>`<option ${y===yr?'selected':''}>${y}</option>`).join('')}</select></div>
  <div class="fg"><label>Month</label><select id="eM">${MONTHS.map((m,i)=>`<option value="${String(i+1).padStart(2,'0')}" ${String(i+1).padStart(2,'0')===mo?'selected':''}>${m}</option>`).join('')}</select></div>
  <div class="fg"><label>District</label><input id="eD" value="A"></div>
  <div class="fg"><label>Contract</label><input id="eC" placeholder="e.g. PA Apron Phase 0"></div></div>
  <div class="form-row c3"><div class="fg"><label>Category</label><select id="eCat" onchange="onCat()"><option value="">Select...</option>${Object.keys(MATERIALS).map(c=>`<option>${c}</option>`).join('')}</select></div>
  <div class="fg"><label>Type</label><select id="eType" onchange="onType()"><option>Select category</option></select></div>
  <div class="fg"><label>Quantity</label><input type="number" id="eQ" placeholder="Enter amount" oninput="preview()"><div class="fg-help" id="eQU">‚Äî</div></div></div>
  <div class="form-row c3"><div class="fg"><label>Baseline EF</label><input id="eBL" class="fg-readonly" readonly></div>
  <div class="fg"><label>Target EF</label><input id="eTG" class="fg-readonly" readonly></div>
  <div class="fg"><label>Actual GWP (EPD)</label><input type="number" id="eA" step="0.01" placeholder="From EPD" oninput="preview()"><div class="fg-help" id="eAU">‚Äî</div></div></div>
  <div class="form-row c3"><div class="fg"><label>Road (km)</label><input type="number" id="eR" value="0" oninput="preview()"></div>
  <div class="fg"><label>Sea (km)</label><input type="number" id="eS" value="0" oninput="preview()"></div>
  <div class="fg"><label>Train (km)</label><input type="number" id="eT" value="0" oninput="preview()"></div></div>
  <div class="fg" style="margin-bottom:12px"><label>Notes</label><input id="eN" placeholder="EPD reference, assumptions..."></div>
  <div id="ePrev"></div>
  <div class="btn-row"><button class="btn btn-primary" onclick="submitEntry()">üíæ Submit Entry</button><button class="btn btn-secondary" onclick="navigate('entry_a13')">üîÑ Clear</button></div></div>
  <div class="card"><div class="card-title">Recent Entries</div><div class="tbl-wrap"><table><thead><tr><th>Month</th><th>Material</th><th>Type</th><th class="r">Qty</th><th class="r">Baseline</th><th class="r">Actual</th><th class="r">A4</th><th class="r">Total</th><th>Status</th><th></th></tr></thead><tbody id="reTbl"></tbody></table></div></div>`;
  renderRecent();
}

function onCat(){const c=$('eCat').value;if(!c||!MATERIALS[c])return;$('eType').innerHTML='<option value="">Select...</option>'+MATERIALS[c].types.map((t,i)=>`<option value="${i}">${t.name}</option>`).join('');$('eQU').textContent='Unit: '+MATERIALS[c].unit;$('eAU').textContent=MATERIALS[c].efUnit;$('eBL').value='';$('eTG').value='';preview();}
function onType(){const c=$('eCat').value,i=$('eType').value;if(!c||i==='')return;const t=MATERIALS[c].types[i];$('eBL').value=t.baseline+' '+MATERIALS[c].efUnit;$('eTG').value=t.target+' '+MATERIALS[c].efUnit;preview();}

function preview(){
  const c=$('eCat').value,i=$('eType').value,q=parseFloat($('eQ').value),a=parseFloat($('eA').value);
  if(!c||i===''||isNaN(q)||isNaN(a)||q<=0||a<=0){$('ePrev').innerHTML='';return;}
  const m=MATERIALS[c],t=m.types[i],mass=q*m.massFactor;
  const rd=parseFloat($('eR').value)||0,se=parseFloat($('eS').value)||0,tr=parseFloat($('eT').value)||0;
  const b=(q*t.baseline)/1000,ac=(q*a)/1000,a4=(mass*rd*TEF.road+mass*se*TEF.sea+mass*tr*TEF.train)/1000;
  const tot=ac+a4,p=b>0?((b-ac)/b)*100:0,cl=p>20?'green':p>=10?'orange':'purple';
  $('ePrev').innerHTML=`<div class="stats-row" style="margin:16px 0 8px"><div class="stat-card slate"><div class="sc-label">A1-A3 Baseline</div><div class="sc-value">${fmt(b)}</div><div class="sc-sub">ton CO‚ÇÇeq</div></div><div class="stat-card blue"><div class="sc-label">A1-A3 Actual</div><div class="sc-value">${fmt(ac)}</div><div class="sc-sub">ton CO‚ÇÇeq</div></div><div class="stat-card orange"><div class="sc-label">A4 Transport</div><div class="sc-value">${fmt(a4)}</div><div class="sc-sub">ton CO‚ÇÇeq</div></div><div class="stat-card green"><div class="sc-label">A1-A4 Total</div><div class="sc-value">${fmt(tot)}</div><div class="sc-sub">ton CO‚ÇÇeq</div></div><div class="stat-card ${cl}"><div class="sc-label">Reduction</div><div class="sc-value">${fmt(p)}%</div><div class="sc-sub">${fmt(b-ac)} saved</div></div></div>`;
}

async function submitEntry(){
  const c=$('eCat').value,i=$('eType').value,q=parseFloat($('eQ').value),a=parseFloat($('eA').value);
  if(!c||i===''||isNaN(q)||isNaN(a)||q<=0||a<=0){alert('Fill all required fields');return;}
  const m=MATERIALS[c],t=m.types[i],mass=q*m.massFactor;
  const rd=parseFloat($('eR').value)||0,se=parseFloat($('eS').value)||0,tr=parseFloat($('eT').value)||0;
  const b=(q*t.baseline)/1000,ac=(q*a)/1000,a4=(mass*rd*TEF.road+mass*se*TEF.sea+mass*tr*TEF.train)/1000;
  const yr=$('eY').value,mo=$('eM').value;

  const entry={id:Date.now(),category:c,type:t.name,qty:q,unit:m.unit,actual:a,baseline:t.baseline,target:t.target,
    road:rd,sea:se,train:tr,a13B:b,a13A:ac,a4,a14:ac+a4,pct:b>0?((b-ac)/b)*100:0,
    year:yr,month:mo,monthKey:yr+'-'+mo,monthLabel:MONTHS[parseInt(mo)-1]+' '+yr,
    district:$('eD').value,contract:$('eC').value,notes:$('eN').value,
    status:'pending',submittedBy:state.name,role:state.role,submittedAt:new Date().toISOString()};

  await DB.saveEntry(entry);
  state.entries.push(entry);
  buildSidebar(); renderRecent();
  $('ePrev').innerHTML='<div style="padding:12px;background:rgba(52,211,153,0.1);border-radius:10px;color:var(--green);text-align:center;font-weight:600">‚úÖ Entry submitted'+(dbConnected?' & synced to cloud':'')+'</div>';
}

function renderRecent(){
  const t=$('reTbl');if(!t)return;
  const r=[...state.entries].reverse().slice(0,15);
  t.innerHTML=r.length?r.map(e=>`<tr><td>${e.monthLabel}</td><td>${e.category}</td><td>${e.type}</td><td class="r mono">${fmtI(e.qty)}</td><td class="r mono">${fmt(e.a13B)}</td><td class="r mono">${fmt(e.a13A)}</td><td class="r mono">${fmt(e.a4)}</td><td class="r mono" style="font-weight:700">${fmt(e.a14)}</td><td><span class="badge ${e.status}">${e.status}</span></td><td>${e.status==='pending'?`<button class="btn btn-danger btn-sm" onclick="delEntry(${e.id})">‚úï</button>`:''}</td></tr>`).join(''):'<tr><td colspan="10" class="empty">No entries</td></tr>';
}

async function delEntry(id){await DB.deleteEntry(id);state.entries=state.entries.filter(e=>e.id!==id);navigate(state.page);}

// ===== A5 =====
function renderA5(el){
  const yr=new Date().getFullYear(),mo=String(new Date().getMonth()+1).padStart(2,'0');
  el.innerHTML=`<div class="card"><div class="card-title">A5 ‚Äî Site Energy & Water</div>
  <div class="form-row c3"><div class="fg"><label>Year</label><select id="a5Y">${[yr-1,yr,yr+1].map(y=>`<option ${y===yr?'selected':''}>${y}</option>`).join('')}</select></div>
  <div class="fg"><label>Month</label><select id="a5M">${MONTHS.map((m,i)=>`<option value="${String(i+1).padStart(2,'0')}" ${String(i+1).padStart(2,'0')===mo?'selected':''}>${m}</option>`).join('')}</select></div>
  <div class="fg"><label>Source</label><select id="a5S" onchange="onA5S()"><optgroup label="Energy">${A5_EFS.energy.map((e,i)=>`<option value="e${i}">${e.name}</option>`).join('')}</optgroup><optgroup label="Water">${A5_EFS.water.map((e,i)=>`<option value="w${i}">${e.name}</option>`).join('')}</optgroup></select></div></div>
  <div class="form-row c3"><div class="fg"><label>Quantity</label><input type="number" id="a5Q" placeholder="Amount" oninput="calcA5()"><div class="fg-help" id="a5U">L</div></div>
  <div class="fg"><label>EF (auto)</label><input id="a5E" class="fg-readonly" readonly></div>
  <div class="fg"><label>Emission</label><input id="a5R" class="fg-readonly" readonly></div></div>
  <div class="btn-row"><button class="btn btn-primary" onclick="subA5()">üíæ Submit</button></div></div>
  <div class="card"><div class="card-title">A5 Entries</div><div class="tbl-wrap"><table><thead><tr><th>Month</th><th>Source</th><th class="r">Qty</th><th>Unit</th><th class="r">Emission</th><th></th></tr></thead><tbody id="a5B"></tbody></table></div></div>`;
  onA5S(); rA5();
}
function getA5S(){const v=$('a5S').value;const t=v[0],i=parseInt(v.slice(1));return t==='e'?A5_EFS.energy[i]:A5_EFS.water[i];}
function onA5S(){const s=getA5S();$('a5E').value=s.ef+' '+s.efUnit;$('a5U').textContent=s.unit;calcA5();}
function calcA5(){const s=getA5S(),q=parseFloat($('a5Q').value);$('a5R').value=isNaN(q)?'':fmt((q*s.ef)/1000)+' tCO‚ÇÇeq';}
async function subA5(){const s=getA5S(),q=parseFloat($('a5Q').value);if(isNaN(q)||q<=0){alert('Enter quantity');return;}const yr=$('a5Y').value,mo=$('a5M').value;const e={id:Date.now(),source:s.name,qty:q,unit:s.unit,ef:s.ef,emission:(q*s.ef)/1000,year:yr,month:mo,monthKey:yr+'-'+mo,monthLabel:MONTHS[parseInt(mo)-1]+' '+yr};await DB.saveA5Entry(e);state.a5entries.push(e);rA5();$('a5Q').value='';$('a5R').value='‚úÖ Saved';}
function rA5(){const t=$('a5B');if(!t)return;const a=[...state.a5entries].reverse();t.innerHTML=a.length?a.map(e=>`<tr><td>${e.monthLabel}</td><td>${e.source}</td><td class="r mono">${fmtI(e.qty)}</td><td>${e.unit}</td><td class="r mono" style="font-weight:700">${fmt(e.emission)}</td><td><button class="btn btn-danger btn-sm" onclick="dA5(${e.id})">‚úï</button></td></tr>`).join(''):'<tr><td colspan="6" class="empty">No entries</td></tr>';}
async function dA5(id){await DB.deleteA5Entry(id);state.a5entries=state.a5entries.filter(e=>e.id!==id);rA5();}

// ===== APPROVALS =====
function renderApprovals(el){
  const r=state.role;
  const items=r==='consultant'?state.entries.filter(e=>e.status==='pending'):r==='client'?state.entries.filter(e=>e.status==='review'):state.entries;
  el.innerHTML=`<div class="card"><div class="card-title">Workflow</div>
  <div class="flow-steps"><div class="flow-step"><div class="flow-dot done">üèóÔ∏è</div><div class="flow-label">Contractor</div></div><div class="flow-line done"></div><div class="flow-step"><div class="flow-dot ${r==='consultant'?'current':'done'}">üìã</div><div class="flow-label">Consultant</div></div><div class="flow-line ${r==='client'?'done':''}"></div><div class="flow-step"><div class="flow-dot ${r==='client'?'current':''}">üëî</div><div class="flow-label">Client</div></div></div></div>
  <div class="card"><div class="card-title">${items.length} Items</div><div class="tbl-wrap"><table><thead><tr><th>Month</th><th>Material</th><th>Type</th><th>By</th><th class="r">Baseline</th><th class="r">Actual</th><th class="r">Reduction</th><th>Status</th>${r!=='contractor'?'<th>Actions</th>':''}</tr></thead><tbody>${items.length?items.map(e=>`<tr><td>${e.monthLabel}</td><td>${e.category}</td><td>${e.type}</td><td>${e.submittedBy||'‚Äî'}</td><td class="r mono">${fmt(e.a13B)}</td><td class="r mono">${fmt(e.a13A)}</td><td class="r mono" style="color:${e.pct>20?'var(--green)':'var(--orange)'};font-weight:700">${fmt(e.pct)}%</td><td><span class="badge ${e.status}">${e.status}</span></td>${r==='consultant'?`<td><button class="btn btn-approve btn-sm" onclick="appr(${e.id},'review')">‚úì Forward</button> <button class="btn btn-danger btn-sm" onclick="appr(${e.id},'rejected')">‚úï</button></td>`:''}${r==='client'?`<td><button class="btn btn-approve btn-sm" onclick="appr(${e.id},'approved')">‚úì Approve</button> <button class="btn btn-danger btn-sm" onclick="appr(${e.id},'rejected')">‚úï</button></td>`:''}</tr>`).join(''):'<tr><td colspan="9" class="empty">No pending items</td></tr>'}</tbody></table></div></div>`;
}
async function appr(id,s){await DB.updateEntry(id,{status:s,[state.role+'At']:new Date().toISOString(),[state.role+'By']:state.name});const e=state.entries.find(x=>x.id===id);if(e)e.status=s;buildSidebar();navigate('approvals');}

// ===== MONTHLY =====
function renderMonthly(el){
  const map={};state.entries.forEach(e=>{if(!map[e.monthKey])map[e.monthKey]={l:e.monthLabel,n:0,b:0,a:0,a4:0,t:0};const m=map[e.monthKey];m.n++;m.b+=e.a13B;m.a+=e.a13A;m.a4+=e.a4;m.t+=e.a14;});
  const arr=Object.entries(map).sort((a,b)=>a[0].localeCompare(b[0]));
  let gB=0,gA=0,gA4=0,gT=0;
  el.innerHTML=`<div class="card"><div class="card-title">Monthly Summary</div><div class="tbl-wrap"><table><thead><tr><th>Month</th><th class="r">Entries</th><th class="r">A1-A3 Baseline</th><th class="r">A1-A3 Actual</th><th class="r">A4</th><th class="r">A1-A4 Total</th><th class="r">Reduction</th></tr></thead><tbody>${arr.length?arr.map(([k,m])=>{gB+=m.b;gA+=m.a;gA4+=m.a4;gT+=m.t;const p=m.b>0?((m.b-m.a)/m.b)*100:0;return`<tr><td>${m.l}</td><td class="r">${m.n}</td><td class="r mono">${fmt(m.b)}</td><td class="r mono">${fmt(m.a)}</td><td class="r mono">${fmt(m.a4)}</td><td class="r mono" style="font-weight:700">${fmt(m.t)}</td><td class="r mono" style="color:${p>20?'var(--green)':'var(--orange)'};font-weight:700">${fmt(p)}%</td></tr>`;}).join('')+(arr.length>1?`<tr class="total-row"><td>Total</td><td class="r">${state.entries.length}</td><td class="r">${fmt(gB)}</td><td class="r">${fmt(gA)}</td><td class="r">${fmt(gA4)}</td><td class="r">${fmt(gT)}</td><td class="r" style="color:var(--green)">${fmt(gB>0?((gB-gA)/gB)*100:0)}%</td></tr>`:''):'<tr><td colspan="7" class="empty">No data</td></tr>'}</tbody></table></div></div>`;
}

// ===== CUMULATIVE =====
function renderCumulative(el){
  const map={};state.entries.forEach(e=>{if(!map[e.monthKey])map[e.monthKey]={l:e.monthLabel,b:0,a:0,a4:0};map[e.monthKey].b+=e.a13B;map[e.monthKey].a+=e.a13A;map[e.monthKey].a4+=e.a4;});
  const arr=Object.entries(map).sort((a,b)=>a[0].localeCompare(b[0]));
  let cB=0,cA=0,cA4=0;
  const cum=arr.map(([k,v])=>{cB+=v.b;cA+=v.a;cA4+=v.a4;return{l:v.l,mb:v.b,ma:v.a,cB,cA,cA4,cT:cA+cA4,cP:cB>0?((cB-cA)/cB)*100:0};});
  const mx=Math.max(...cum.map(c=>Math.max(c.cB,c.cA)),1);
  el.innerHTML=`<div class="card"><div class="card-title">Cumulative Tracking</div>${cum.length?`<div class="chart-legend"><span><span class="chart-legend-dot" style="background:rgba(148,163,184,0.4)"></span> Baseline</span><span><span class="chart-legend-dot" style="background:rgba(96,165,250,0.5)"></span> Actual</span></div><div class="bar-chart" style="height:180px">${cum.map(c=>`<div class="bar-group"><div class="bar-pair"><div class="bar baseline" style="height:${(c.cB/mx)*160}px"></div><div class="bar actual" style="height:${(c.cA/mx)*160}px"></div></div><div class="bar-label">${c.l}</div></div>`).join('')}</div>`:''}
  <div class="tbl-wrap" style="margin-top:16px"><table><thead><tr><th>Month</th><th class="r">Mth Base</th><th class="r">Mth Actual</th><th class="r">Cum Base</th><th class="r">Cum Actual</th><th class="r">Cum A4</th><th class="r">Cum Total</th><th class="r">Cum Red%</th></tr></thead><tbody>${cum.length?cum.map(c=>`<tr><td>${c.l}</td><td class="r mono">${fmt(c.mb)}</td><td class="r mono">${fmt(c.ma)}</td><td class="r mono" style="font-weight:700">${fmt(c.cB)}</td><td class="r mono" style="font-weight:700;color:var(--blue)">${fmt(c.cA)}</td><td class="r mono">${fmt(c.cA4)}</td><td class="r mono" style="font-weight:700;color:var(--green)">${fmt(c.cT)}</td><td class="r mono" style="color:${c.cP>20?'var(--green)':'var(--orange)'};font-weight:700">${fmt(c.cP)}%</td></tr>`).join(''):'<tr><td colspan="8" class="empty">No data</td></tr>'}</tbody></table></div></div>`;
}

// ===== BASELINES =====
function renderBaselines(el){
  let h='';Object.entries(MATERIALS).forEach(([c,m])=>{h+=`<div class="card"><div class="card-title">${c}</div><div class="tbl-wrap"><table><thead><tr><th>Type</th><th class="r">Baseline EF</th><th class="r">Target EF</th><th>Unit</th><th class="r">Mass Factor</th></tr></thead><tbody>${m.types.map(t=>`<tr><td>${t.name}</td><td class="r mono">${t.baseline}</td><td class="r mono" style="color:var(--green)">${t.target}</td><td>${m.efUnit}</td><td class="r mono">${m.massFactor}</td></tr>`).join('')}</tbody></table></div></div>`;});
  h+=`<div class="card"><div class="card-title">A5 Emission Factors</div><div class="tbl-wrap"><table><thead><tr><th>Source</th><th class="r">EF</th><th>Unit</th></tr></thead><tbody>${[...A5_EFS.energy,...A5_EFS.water].map(e=>`<tr><td>${e.name}</td><td class="r mono" style="color:var(--green)">${e.ef}</td><td>${e.efUnit}</td></tr>`).join('')}</tbody></table></div></div>`;
  el.innerHTML=h;
}

// ===== CERTS =====
function renderCerts(el){
  el.innerHTML=`<div class="card"><div class="card-title">Certification Tracker</div><div class="cert-grid">${CERTS.map(c=>`<div class="cert-card"><div class="cc-icon">${c.icon}</div><div class="cc-name">${c.name}</div><div class="cc-status">${c.tgt}/${c.cr} credits</div><div class="cc-bar"><div class="cc-fill" style="width:${(c.tgt/c.cr)*100}%;background:${c.color}"></div></div></div>`).join('')}</div></div>
  <div class="card"><div class="card-title">Credit Mapping</div><div class="tbl-wrap"><table><thead><tr><th>Cert</th><th>Credit</th><th>Name</th><th>Carbon Link</th><th>Status</th></tr></thead><tbody>
  <tr><td>Envision</td><td>CR1.1</td><td>Reduce Embodied Carbon</td><td>A1-A3</td><td><span class="badge review">In Progress</span></td></tr>
  <tr><td>LEED</td><td>MRc2</td><td>Life-Cycle Impact</td><td>A1-A4</td><td><span class="badge pending">Pending</span></td></tr>
  <tr><td>Mostadam</td><td>MAT-1</td><td>Embodied Carbon</td><td>A1-A3</td><td><span class="badge review">In Progress</span></td></tr>
  <tr><td>BREEAM</td><td>Mat01</td><td>Life Cycle Impacts</td><td>A1-A5</td><td><span class="badge pending">Pending</span></td></tr>
  <tr><td>WELL</td><td>A08</td><td>Healthy Materials</td><td>EPDs</td><td><span class="badge pending">Pending</span></td></tr>
  </tbody></table></div></div>`;
}

// ===== INTEGRATIONS =====
function renderIntegrations(el){
  const apis=[{i:"üîó",n:"EPD Hub API",d:"Auto-fetch emission factors"},{i:"üìä",n:"EC3 / Building Transparency",d:"Material carbon benchmarks"},{i:"üåê",n:"One Click LCA",d:"Whole-building LCA sync"},{i:"üì°",n:"IEA Data API",d:"Grid emission factors by region"},{i:"üìÅ",n:"Power BI Export",d:"Advanced analytics export"},{i:"üîê",n:"KSIA Portal",d:"Project management sync"},{i:"‚òÅÔ∏è",n:"Firebase Cloud DB",d:"Real-time cloud database",on:dbConnected},{i:"üìß",n:"Email Notifications",d:"Stakeholder alerts"}];
  el.innerHTML=`<div class="card"><div class="card-title">Integration Hub</div>${apis.map(a=>`<div class="api-item"><div class="api-left"><span class="api-icon">${a.i}</span><div><div class="api-name">${a.n}</div><div class="api-desc">${a.d}</div></div></div><div class="toggle${a.on?' on':''}" onclick="this.classList.toggle('on')"></div></div>`).join('')}</div>
  <div class="card"><div class="card-title">Database Status</div><div style="padding:16px;background:var(--bg3);border-radius:10px;font-size:13px"><strong style="color:${dbConnected?'var(--green)':'var(--red)'}">‚óè</strong> ${dbConnected?'Connected to Firebase Cloud Database ‚Äî data syncs in real-time across all users':'Running in offline mode ‚Äî data saved locally. Connect Firebase for cloud sync.'}<br><br><span style="color:var(--slate5);font-size:11px">Database: Firebase Realtime DB | Project: KSIA | Path: /projects/ksia/</span></div></div>`;
}
</script>
</body>
</html>
